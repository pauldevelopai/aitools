{% extends "base.html" %}

{% block title %}{{ policy.title }} - {{ product_name }}{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 sm:px-0">

    <!-- Header -->
    <div class="flex items-start justify-between mb-8">
        <div>
            <a href="/ethics-builder" class="text-sm text-gray-500 hover:text-gray-700 mb-2 inline-block">&larr; Back to policies</a>
            <h1 class="text-3xl font-bold text-gray-900">{{ policy.title }}</h1>
            <p class="text-sm text-gray-500 mt-1">
                Version {{ version.version_number }}
                &middot;
                {% if version.status == 'published' %}
                    <span class="text-green-700 font-medium">Published</span>
                    {% if version.published_at %}
                        {{ version.published_at.strftime('%d %b %Y') }}
                    {% endif %}
                {% elif version.status == 'draft' %}
                    <span class="text-yellow-700 font-medium">Draft</span>
                {% else %}
                    <span class="text-gray-500">{{ version.status | title }}</span>
                {% endif %}
            </p>
        </div>
        {% if is_owner %}
        <div class="flex gap-2">
            {% if version.status == 'draft' %}
            <a href="/ethics-builder/{{ policy.id }}/edit" class="inline-flex items-center px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-md hover:bg-indigo-700 transition">
                Edit
            </a>
            {% elif version.status == 'published' %}
            <form method="POST" action="/ethics-builder/{{ policy.id }}/new-draft" class="inline">
                <button type="submit" class="inline-flex items-center px-4 py-2 text-sm font-medium text-indigo-700 bg-indigo-50 border border-indigo-300 rounded-md hover:bg-indigo-100 transition">
                    New Draft
                </button>
            </form>
            {% endif %}
            <a href="/ethics-builder/{{ policy.id }}/export" class="inline-flex items-center px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 transition">
                Export
            </a>
            <a href="/ethics-builder/{{ policy.id }}/versions" class="inline-flex items-center px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 transition">
                History
            </a>
        </div>
        {% endif %}
    </div>

    <!-- Rendered Sections -->
    {% if version.sections_data %}
    <div class="space-y-8">
        {% for s in sections %}
            {% set section = version.sections_data.get(s.key) %}
            {% if section and section.get('content') %}
            <div class="bg-white rounded-lg shadow p-6">
                <div class="prose prose-sm max-w-none">
                    {{ section.content | markdown }}
                </div>
            </div>
            {% endif %}
        {% endfor %}
    </div>
    {% elif version.content_markdown %}
    <div class="bg-white rounded-lg shadow p-6">
        <div class="prose prose-sm max-w-none">
            {{ version.content_markdown | markdown }}
        </div>
    </div>
    {% endif %}

</div>
{% endblock %}
