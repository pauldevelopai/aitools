{% extends "base.html" %}

{% block title %}Edit Policy - {{ policy.title }} - {{ product_name }}{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto px-4 sm:px-0">

    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
        <div class="flex items-center gap-4">
            <a href="/ethics-builder" class="text-gray-500 hover:text-gray-700">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
            </a>
            <div>
                <input
                    type="text"
                    id="policy-title"
                    value="{{ policy.title }}"
                    class="text-2xl font-bold text-gray-900 bg-transparent border-0 border-b-2 border-transparent hover:border-gray-300 focus:border-indigo-500 focus:ring-0 px-0 py-1 w-96"
                    placeholder="Policy Title"
                >
                <p class="text-sm text-gray-500 mt-1">
                    Draft v{{ version.version_number }}
                    &middot; <span id="save-status" class="text-gray-400">Ready</span>
                </p>
            </div>
        </div>
        <div class="flex gap-3">
            <a href="/ethics-builder/{{ policy.id }}/versions" class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 transition">
                History
            </a>
            <form method="POST" action="/ethics-builder/{{ policy.id }}/publish" class="inline">
                <button type="submit" class="inline-flex items-center px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-md hover:bg-green-700 transition" onclick="return confirm('Publish this policy? It will become the current published version.')">
                    Publish
                </button>
            </form>
        </div>
    </div>

    <!-- Editor Layout -->
    <div class="flex gap-6">
        <!-- Sidebar: Section Navigation -->
        <div class="w-64 flex-shrink-0">
            <nav class="bg-white rounded-lg shadow p-3 sticky top-4">
                <h3 class="text-xs font-semibold text-gray-400 uppercase tracking-wider px-3 mb-2">Sections</h3>
                <ul class="space-y-0.5">
                    {% for s in sections %}
                    <li>
                        <button
                            data-section="{{ s.key }}"
                            class="section-btn w-full text-left px-3 py-2 text-sm rounded-md transition {% if loop.first %}bg-indigo-50 text-indigo-700 font-medium{% else %}text-gray-700 hover:bg-gray-50{% endif %}"
                        >
                            <span class="flex items-center justify-between">
                                {{ s.title }}
                                <svg class="w-3 h-3 text-green-500 hidden section-saved-{{ s.key }}" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                                </svg>
                            </span>
                        </button>
                    </li>
                    {% endfor %}
                </ul>
            </nav>
        </div>

        <!-- Main: Guidance + Editor -->
        <div class="flex-1 min-w-0">
            <!-- Guidance Box -->
            <div id="guidance-box" class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                <h4 class="text-sm font-semibold text-blue-900 mb-1" id="guidance-title"></h4>
                <p class="text-sm text-blue-700" id="guidance-text"></p>
            </div>

            <!-- Textarea -->
            <div class="bg-white rounded-lg shadow">
                <textarea
                    id="section-editor"
                    rows="20"
                    class="w-full p-6 text-sm text-gray-800 font-mono border-0 rounded-lg focus:ring-2 focus:ring-indigo-500 resize-y"
                    placeholder="Start writing..."
                ></textarea>
            </div>
        </div>
    </div>
</div>

<script>
(function() {
    // Section data loaded from server
    const sectionsData = {{ version.sections_data | tojson }};
    const sectionsMeta = {{ sections | tojson }};
    const policyId = "{{ policy.id }}";

    let currentSection = sectionsMeta[0].key;
    let autosaveTimer = null;
    let titleTimer = null;

    const editor = document.getElementById('section-editor');
    const guidanceTitle = document.getElementById('guidance-title');
    const guidanceText = document.getElementById('guidance-text');
    const saveStatus = document.getElementById('save-status');
    const titleInput = document.getElementById('policy-title');

    // Build section map for quick lookup
    const sectionMetaMap = {};
    sectionsMeta.forEach(s => { sectionMetaMap[s.key] = s; });

    function switchSection(key) {
        // Save current content to local data
        sectionsData[currentSection] = sectionsData[currentSection] || {};
        sectionsData[currentSection].content = editor.value;

        // Switch
        currentSection = key;

        // Update editor
        const sectionContent = (sectionsData[key] && sectionsData[key].content) || '';
        editor.value = sectionContent;

        // Update guidance
        const meta = sectionMetaMap[key];
        guidanceTitle.textContent = meta.title;
        guidanceText.textContent = meta.guidance;

        // Update sidebar active state
        document.querySelectorAll('.section-btn').forEach(btn => {
            if (btn.dataset.section === key) {
                btn.classList.add('bg-indigo-50', 'text-indigo-700', 'font-medium');
                btn.classList.remove('text-gray-700', 'hover:bg-gray-50');
            } else {
                btn.classList.remove('bg-indigo-50', 'text-indigo-700', 'font-medium');
                btn.classList.add('text-gray-700', 'hover:bg-gray-50');
            }
        });
    }

    function autosave() {
        const content = editor.value;
        sectionsData[currentSection] = sectionsData[currentSection] || {};
        sectionsData[currentSection].content = content;

        saveStatus.textContent = 'Saving...';
        saveStatus.className = 'text-yellow-600';

        fetch(`/ethics-builder/${policyId}/autosave`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ section_key: currentSection, content: content }),
        })
        .then(r => r.json())
        .then(data => {
            if (data.status === 'ok') {
                saveStatus.textContent = 'Saved';
                saveStatus.className = 'text-green-600';
                // Show checkmark on sidebar
                const icon = document.querySelector(`.section-saved-${currentSection}`);
                if (icon) icon.classList.remove('hidden');
                setTimeout(() => {
                    if (saveStatus.textContent === 'Saved') {
                        saveStatus.textContent = 'Ready';
                        saveStatus.className = 'text-gray-400';
                    }
                }, 3000);
            } else {
                saveStatus.textContent = 'Error saving';
                saveStatus.className = 'text-red-600';
            }
        })
        .catch(() => {
            saveStatus.textContent = 'Error saving';
            saveStatus.className = 'text-red-600';
        });
    }

    function saveTitle() {
        const title = titleInput.value.trim();
        if (!title) return;

        fetch(`/ethics-builder/${policyId}/title`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ title: title }),
        });
    }

    // Event listeners
    editor.addEventListener('input', () => {
        clearTimeout(autosaveTimer);
        saveStatus.textContent = 'Editing...';
        saveStatus.className = 'text-gray-400';
        autosaveTimer = setTimeout(autosave, 1500);
    });

    titleInput.addEventListener('input', () => {
        clearTimeout(titleTimer);
        titleTimer = setTimeout(saveTitle, 1500);
    });

    document.querySelectorAll('.section-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            // Trigger save before switching
            if (autosaveTimer) {
                clearTimeout(autosaveTimer);
                autosave();
            }
            switchSection(btn.dataset.section);
        });
    });

    // Initialize first section
    switchSection(currentSection);
})();
</script>
{% endblock %}
