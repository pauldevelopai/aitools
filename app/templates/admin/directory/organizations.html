{% extends "admin/base.html" %}

{% block title %}Organizations{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex justify-between items-center">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">Media Organizations</h1>
            <p class="text-gray-600">{{ organizations|length }} organization{% if organizations|length != 1 %}s{% endif %}</p>
        </div>
        <div class="flex space-x-3">
            {% if feature_admin_directory_import %}
            <a href="/admin/directory/import" class="px-4 py-2 bg-emerald-500 text-white rounded-md hover:bg-emerald-600 text-sm font-medium flex items-center">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                </svg>
                Import
            </a>
            {% endif %}
            <a href="/admin/directory/organizations/new" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm font-medium">
                + Add Organization
            </a>
        </div>
    </div>

    <!-- Filters -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
        <form method="GET" class="flex flex-wrap gap-4 items-end">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Type</label>
                <select name="org_type" class="border border-gray-300 rounded-md px-3 py-2 text-sm">
                    <option value="">All Types</option>
                    {% for t in org_types %}
                    <option value="{{ t }}" {% if filters.org_type == t %}selected{% endif %}>{{ t|title }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Country</label>
                <select name="country" class="border border-gray-300 rounded-md px-3 py-2 text-sm">
                    <option value="">All Countries</option>
                    {% for c in countries %}
                    <option value="{{ c }}" {% if filters.country == c %}selected{% endif %}>{{ c }}</option>
                    {% endfor %}
                </select>
            </div>
            {% if clients is defined and clients %}
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Client</label>
                <select name="client_id" class="border border-gray-300 rounded-md px-3 py-2 text-sm">
                    <option value="">All Clients</option>
                    {% for client in clients %}
                    <option value="{{ client.id }}" {% if filters.client_id == client.id|string %}selected{% endif %}>{{ client.name }}</option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">AI Journey</label>
                <select name="journey_stage" class="border border-gray-300 rounded-md px-3 py-2 text-sm">
                    <option value="">All Stages</option>
                    {% for key, label in [("not_started", "Not Started"), ("awareness", "Awareness"), ("exploring", "Exploring"), ("piloting", "Piloting"), ("implementing", "Implementing"), ("integrated", "Integrated"), ("advanced", "Advanced")] %}
                    <option value="{{ key }}" {% if filters.journey_stage == key %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="flex-1">
                <label class="block text-sm font-medium text-gray-700 mb-1">Search</label>
                <input type="text" name="search" value="{{ filters.search or '' }}" placeholder="Search by name..." class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm">
            </div>
            <button type="submit" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 text-sm font-medium">
                Filter
            </button>
            {% if filters.org_type or filters.country or filters.search or filters.client_id or filters.journey_stage %}
            <a href="/admin/directory/organizations" class="px-4 py-2 text-gray-600 hover:text-gray-900 text-sm">
                Clear
            </a>
            {% endif %}
        </form>
    </div>

    <!-- View Toggle -->
    <div class="flex justify-end">
        <div class="inline-flex rounded-md shadow-sm" role="group">
            <button onclick="setView('table')" id="btn-table" class="px-4 py-2 text-sm font-medium border border-gray-300 rounded-l-lg bg-white text-gray-700 hover:bg-gray-50 focus:bg-gray-100">
                <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path>
                </svg>
                Table
            </button>
            <button onclick="setView('card')" id="btn-card" class="px-4 py-2 text-sm font-medium border border-gray-300 rounded-r-lg bg-white text-gray-700 hover:bg-gray-50 focus:bg-gray-100">
                <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path>
                </svg>
                Cards
            </button>
        </div>
    </div>

    <!-- Table View -->
    <div id="table-view" class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Country</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Client</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">AI Journey</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Journalists</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for org in organizations %}
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            {% if org.logo_url %}
                            <img src="{{ org.logo_url }}" alt="" class="w-8 h-8 rounded mr-3 object-cover">
                            {% else %}
                            <div class="w-8 h-8 rounded mr-3 bg-gray-200 flex items-center justify-center text-gray-500 text-xs font-medium">
                                {{ org.name[:2]|upper }}
                            </div>
                            {% endif %}
                            <div>
                                <a href="/admin/directory/organizations/{{ org.id }}" class="font-medium text-gray-900 hover:text-blue-600">{{ org.name }}</a>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        {% if org.org_type == 'newspaper' %}
                        <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs font-medium">Newspaper</span>
                        {% elif org.org_type == 'broadcaster' %}
                        <span class="px-2 py-1 bg-purple-100 text-purple-800 rounded text-xs font-medium">Broadcaster</span>
                        {% elif org.org_type == 'digital' %}
                        <span class="px-2 py-1 bg-green-100 text-green-800 rounded text-xs font-medium">Digital</span>
                        {% elif org.org_type == 'agency' %}
                        <span class="px-2 py-1 bg-amber-100 text-amber-800 rounded text-xs font-medium">Agency</span>
                        {% elif org.org_type == 'magazine' %}
                        <span class="px-2 py-1 bg-pink-100 text-pink-800 rounded text-xs font-medium">Magazine</span>
                        {% else %}
                        <span class="px-2 py-1 bg-gray-100 text-gray-800 rounded text-xs font-medium">{{ org.org_type|title }}</span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {{ org.country or '-' }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {% if org.client %}
                        <span class="px-2 py-1 bg-indigo-50 text-indigo-700 rounded text-xs">{{ org.client.name }}</span>
                        {% else %}
                        -
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        {% set stage_badge = {
                            "not_started": "bg-gray-100 text-gray-700",
                            "awareness": "bg-blue-100 text-blue-700",
                            "exploring": "bg-indigo-100 text-indigo-700",
                            "piloting": "bg-amber-100 text-amber-700",
                            "implementing": "bg-orange-100 text-orange-700",
                            "integrated": "bg-green-100 text-green-700",
                            "advanced": "bg-emerald-100 text-emerald-700",
                        } %}
                        {% set stage_label = {
                            "not_started": "Not Started",
                            "awareness": "Awareness",
                            "exploring": "Exploring",
                            "piloting": "Piloting",
                            "implementing": "Implementing",
                            "integrated": "Integrated",
                            "advanced": "Advanced",
                        } %}
                        {% set current_stage = org.ai_journey_stage or 'not_started' %}
                        <span class="px-2 py-1 rounded text-xs font-medium {{ stage_badge.get(current_stage, 'bg-gray-100 text-gray-700') }}">{{ stage_label.get(current_stage, 'Not Started') }}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {{ org_journalist_counts.get(org.id, 0) }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        {% if org.is_active %}
                        <span class="px-2 py-1 bg-green-100 text-green-800 rounded text-xs">Active</span>
                        {% else %}
                        <span class="px-2 py-1 bg-gray-100 text-gray-600 rounded text-xs">Inactive</span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm">
                        <a href="/admin/directory/organizations/{{ org.id }}" class="text-blue-600 hover:text-blue-900 mr-3">View</a>
                        <a href="/admin/directory/organizations/{{ org.id }}/edit" class="text-gray-600 hover:text-gray-900">Edit</a>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="8" class="px-6 py-8 text-center text-gray-500">
                        No organizations found
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Card View -->
    <div id="card-view" class="hidden">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {% for org in organizations %}
            <a href="/admin/directory/organizations/{{ org.id }}" class="bg-white rounded-lg shadow-sm border border-gray-200 p-5 hover:border-blue-300 hover:shadow transition">
                <div class="flex items-start justify-between">
                    <div class="flex items-center">
                        {% if org.logo_url %}
                        <img src="{{ org.logo_url }}" alt="" class="w-10 h-10 rounded mr-3 object-cover">
                        {% else %}
                        <div class="w-10 h-10 rounded mr-3 bg-gray-200 flex items-center justify-center text-gray-500 text-sm font-medium">
                            {{ org.name[:2]|upper }}
                        </div>
                        {% endif %}
                        <div>
                            <h3 class="font-semibold text-gray-900">{{ org.name }}</h3>
                            <p class="text-sm text-gray-500">{{ org.country or 'No country' }}</p>
                        </div>
                    </div>
                    {% if org.is_active %}
                    <span class="w-2 h-2 bg-green-500 rounded-full mt-2"></span>
                    {% else %}
                    <span class="w-2 h-2 bg-gray-400 rounded-full mt-2"></span>
                    {% endif %}
                </div>
                <div class="mt-3 flex items-center justify-between">
                    <div>
                        {% if org.org_type == 'newspaper' %}
                        <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs font-medium">Newspaper</span>
                        {% elif org.org_type == 'broadcaster' %}
                        <span class="px-2 py-1 bg-purple-100 text-purple-800 rounded text-xs font-medium">Broadcaster</span>
                        {% elif org.org_type == 'digital' %}
                        <span class="px-2 py-1 bg-green-100 text-green-800 rounded text-xs font-medium">Digital</span>
                        {% elif org.org_type == 'agency' %}
                        <span class="px-2 py-1 bg-amber-100 text-amber-800 rounded text-xs font-medium">Agency</span>
                        {% elif org.org_type == 'magazine' %}
                        <span class="px-2 py-1 bg-pink-100 text-pink-800 rounded text-xs font-medium">Magazine</span>
                        {% else %}
                        <span class="px-2 py-1 bg-gray-100 text-gray-800 rounded text-xs font-medium">{{ org.org_type|title }}</span>
                        {% endif %}
                        {% if org.client %}
                        <span class="px-2 py-1 bg-indigo-50 text-indigo-700 rounded text-xs ml-1">{{ org.client.name }}</span>
                        {% endif %}
                    </div>
                    <span class="text-xs text-gray-500">{{ org_journalist_counts.get(org.id, 0) }} journalists</span>
                </div>
                <div class="mt-2">
                    {% set current_stage = org.ai_journey_stage or 'not_started' %}
                    {% set card_badge = {
                        "not_started": "bg-gray-100 text-gray-700",
                        "awareness": "bg-blue-100 text-blue-700",
                        "exploring": "bg-indigo-100 text-indigo-700",
                        "piloting": "bg-amber-100 text-amber-700",
                        "implementing": "bg-orange-100 text-orange-700",
                        "integrated": "bg-green-100 text-green-700",
                        "advanced": "bg-emerald-100 text-emerald-700",
                    } %}
                    {% set card_label = {
                        "not_started": "Not Started",
                        "awareness": "Awareness",
                        "exploring": "Exploring",
                        "piloting": "Piloting",
                        "implementing": "Implementing",
                        "integrated": "Integrated",
                        "advanced": "Advanced",
                    } %}
                    <span class="px-2 py-0.5 rounded text-xs font-medium {{ card_badge.get(current_stage, 'bg-gray-100 text-gray-700') }}">AI: {{ card_label.get(current_stage, 'Not Started') }}</span>
                </div>
                {% if org.description %}
                <p class="mt-2 text-sm text-gray-600 line-clamp-2">{{ org.description[:100] }}{% if org.description|length > 100 %}...{% endif %}</p>
                {% endif %}
            </a>
            {% else %}
            <div class="col-span-3 text-center py-8 text-gray-500">No organizations found</div>
            {% endfor %}
        </div>
    </div>

    <!-- Pagination -->
    {% if total_pages is defined and total_pages > 1 %}
    <div class="flex justify-center">
        <nav class="inline-flex rounded-md shadow-sm -space-x-px">
            {% if current_page > 1 %}
            <a href="?page={{ current_page - 1 }}{% if filters.org_type %}&org_type={{ filters.org_type }}{% endif %}{% if filters.country %}&country={{ filters.country }}{% endif %}{% if filters.search %}&search={{ filters.search }}{% endif %}{% if filters.client_id %}&client_id={{ filters.client_id }}{% endif %}{% if filters.journey_stage %}&journey_stage={{ filters.journey_stage }}{% endif %}"
                class="px-3 py-2 border border-gray-300 bg-white text-sm text-gray-500 hover:bg-gray-50 rounded-l-md">&laquo; Prev</a>
            {% endif %}
            {% for p in range(1, total_pages + 1) %}
            <a href="?page={{ p }}{% if filters.org_type %}&org_type={{ filters.org_type }}{% endif %}{% if filters.country %}&country={{ filters.country }}{% endif %}{% if filters.search %}&search={{ filters.search }}{% endif %}{% if filters.client_id %}&client_id={{ filters.client_id }}{% endif %}{% if filters.journey_stage %}&journey_stage={{ filters.journey_stage }}{% endif %}"
                class="px-3 py-2 border border-gray-300 text-sm {% if p == current_page %}bg-blue-50 text-blue-600 font-medium{% else %}bg-white text-gray-500 hover:bg-gray-50{% endif %}">{{ p }}</a>
            {% endfor %}
            {% if current_page < total_pages %}
            <a href="?page={{ current_page + 1 }}{% if filters.org_type %}&org_type={{ filters.org_type }}{% endif %}{% if filters.country %}&country={{ filters.country }}{% endif %}{% if filters.search %}&search={{ filters.search }}{% endif %}{% if filters.client_id %}&client_id={{ filters.client_id }}{% endif %}{% if filters.journey_stage %}&journey_stage={{ filters.journey_stage }}{% endif %}"
                class="px-3 py-2 border border-gray-300 bg-white text-sm text-gray-500 hover:bg-gray-50 rounded-r-md">Next &raquo;</a>
            {% endif %}
        </nav>
    </div>
    {% endif %}
</div>

<script>
function setView(view) {
    const tableView = document.getElementById('table-view');
    const cardView = document.getElementById('card-view');
    const btnTable = document.getElementById('btn-table');
    const btnCard = document.getElementById('btn-card');

    if (view === 'card') {
        tableView.classList.add('hidden');
        cardView.classList.remove('hidden');
        btnCard.classList.add('bg-gray-100', 'text-gray-900');
        btnCard.classList.remove('bg-white');
        btnTable.classList.remove('bg-gray-100', 'text-gray-900');
        btnTable.classList.add('bg-white');
    } else {
        cardView.classList.add('hidden');
        tableView.classList.remove('hidden');
        btnTable.classList.add('bg-gray-100', 'text-gray-900');
        btnTable.classList.remove('bg-white');
        btnCard.classList.remove('bg-gray-100', 'text-gray-900');
        btnCard.classList.add('bg-white');
    }

    localStorage.setItem('orgViewMode', view);
}

// Restore saved view
const savedView = localStorage.getItem('orgViewMode');
if (savedView) setView(savedView);
else setView('table');
</script>
{% endblock %}
