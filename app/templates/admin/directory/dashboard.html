{% extends "admin/base.html" %}

{% block title %}Directory Dashboard{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex justify-between items-center">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">Directory</h1>
            <p class="text-gray-600">Manage journalists, media organizations, and AI training engagements</p>
        </div>
        <div class="flex space-x-3">
            {% if feature_admin_directory_import %}
            <a href="/admin/directory/import" class="px-4 py-2 bg-emerald-500 text-white rounded-md hover:bg-emerald-600 text-sm font-medium flex items-center">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                </svg>
                Import Spreadsheet
            </a>
            {% endif %}
            <a href="/admin/directory/sync" class="px-4 py-2 bg-indigo-500 text-white rounded-md hover:bg-indigo-600 text-sm font-medium flex items-center">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
                GROUNDED Sync
            </a>
            <a href="/admin/directory/insights" class="px-4 py-2 bg-amber-500 text-white rounded-md hover:bg-amber-600 text-sm font-medium flex items-center">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                </svg>
                AI Insights
            </a>
            <a href="/admin/directory/search" class="px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 text-sm font-medium">
                Search
            </a>
        </div>
    </div>

    <!-- Quick Add Section -->
    <div class="bg-gradient-to-r from-emerald-50 to-teal-50 rounded-lg shadow-sm border border-emerald-200 p-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">Quick Add</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Quick Add Journalist -->
            <form method="POST" action="/admin/directory/journalists" class="bg-white rounded-lg p-4 shadow-sm">
                <h3 class="font-medium text-gray-900 mb-3 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path>
                    </svg>
                    Add Journalist
                </h3>
                <div class="grid grid-cols-2 gap-3">
                    <input type="text" name="first_name" required placeholder="First name *" class="border border-gray-300 rounded px-3 py-2 text-sm">
                    <input type="text" name="last_name" required placeholder="Last name *" class="border border-gray-300 rounded px-3 py-2 text-sm">
                    <input type="email" name="email" placeholder="Email" class="border border-gray-300 rounded px-3 py-2 text-sm">
                    <select name="organization_id" class="border border-gray-300 rounded px-3 py-2 text-sm">
                        <option value="">Organization (optional)</option>
                        {% for org in organizations %}
                        <option value="{{ org.id }}">{{ org.name }}</option>
                        {% endfor %}
                    </select>
                    <input type="text" name="role" placeholder="Role/Title" class="border border-gray-300 rounded px-3 py-2 text-sm">
                    <select name="ai_skill_level" class="border border-gray-300 rounded px-3 py-2 text-sm">
                        <option value="none">AI Skill: None</option>
                        <option value="beginner">AI Skill: Beginner</option>
                        <option value="intermediate">AI Skill: Intermediate</option>
                        <option value="advanced">AI Skill: Advanced</option>
                    </select>
                </div>
                <input type="hidden" name="areas_of_interest" value="[]">
                <div class="mt-3 flex justify-between items-center">
                    <a href="/admin/directory/journalists/new" class="text-sm text-blue-600 hover:underline">Full form &rarr;</a>
                    <button type="submit" class="px-4 py-2 bg-emerald-600 text-white rounded hover:bg-emerald-700 text-sm font-medium">
                        Add Journalist
                    </button>
                </div>
            </form>

            <!-- Quick Add Organization -->
            <form method="POST" action="/admin/directory/organizations" class="bg-white rounded-lg p-4 shadow-sm">
                <h3 class="font-medium text-gray-900 mb-3 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                    </svg>
                    Add Organization
                </h3>
                <div class="grid grid-cols-2 gap-3">
                    <input type="text" name="name" required placeholder="Organization name *" class="col-span-2 border border-gray-300 rounded px-3 py-2 text-sm">
                    <select name="org_type" required class="border border-gray-300 rounded px-3 py-2 text-sm">
                        <option value="">Type *</option>
                        <option value="newspaper">Newspaper</option>
                        <option value="broadcaster">Broadcaster</option>
                        <option value="digital">Digital</option>
                        <option value="agency">News Agency</option>
                        <option value="magazine">Magazine</option>
                        <option value="freelance_collective">Freelance Collective</option>
                    </select>
                    <input type="text" name="country" placeholder="Country" class="border border-gray-300 rounded px-3 py-2 text-sm">
                    <input type="url" name="website" placeholder="Website URL" class="col-span-2 border border-gray-300 rounded px-3 py-2 text-sm">
                </div>
                <div class="mt-3 flex justify-between items-center">
                    <a href="/admin/directory/organizations/new" class="text-sm text-blue-600 hover:underline">Full form &rarr;</a>
                    <button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 text-sm font-medium">
                        Add Organization
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <a href="/admin/directory/organizations" class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 hover:border-blue-300 transition">
            <div class="text-sm font-medium text-gray-500">Organizations</div>
            <div class="text-3xl font-bold text-gray-900 mt-1">{{ stats.organizations }}</div>
        </a>
        <a href="/admin/directory/journalists" class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 hover:border-blue-300 transition">
            <div class="text-sm font-medium text-gray-500">Journalists</div>
            <div class="text-3xl font-bold text-gray-900 mt-1">{{ stats.journalists }}</div>
        </a>
        <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
            <div class="text-sm font-medium text-gray-500">Total Engagements</div>
            <div class="text-3xl font-bold text-gray-900 mt-1">{{ stats.engagements }}</div>
        </div>
        <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
            <div class="text-sm font-medium text-gray-500">This Month</div>
            <div class="text-3xl font-bold text-blue-600 mt-1">{{ stats.this_month }}</div>
        </div>
    </div>

    <!-- AI Journey Pipeline -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">AI Journey Pipeline</h2>
        <p class="text-sm text-gray-500 mb-4">Organization progress through AI adoption stages</p>
        <div class="grid grid-cols-7 gap-2">
            {% set stages = [
                ("not_started", "Not Started", "bg-gray-100", "text-gray-600", "border-gray-200"),
                ("awareness", "Awareness", "bg-blue-50", "text-blue-600", "border-blue-200"),
                ("exploring", "Exploring", "bg-indigo-50", "text-indigo-600", "border-indigo-200"),
                ("piloting", "Piloting", "bg-amber-50", "text-amber-600", "border-amber-200"),
                ("implementing", "Implementing", "bg-orange-50", "text-orange-600", "border-orange-200"),
                ("integrated", "Integrated", "bg-green-50", "text-green-600", "border-green-200"),
                ("advanced", "Advanced", "bg-emerald-50", "text-emerald-600", "border-emerald-200"),
            ] %}
            {% for key, label, bg, text_color, border in stages %}
            <a href="/admin/directory/organizations?journey_stage={{ key }}" class="text-center p-3 {{ bg }} rounded-lg hover:shadow transition border {{ border }}">
                <div class="text-2xl font-bold {{ text_color }}">{{ journey_stats.get(key, 0) }}</div>
                <div class="text-xs text-gray-500 mt-1">{{ label }}</div>
            </a>
            {% endfor %}
        </div>
    </div>

    <!-- Recently Added Organizations -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200">
        <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
            <h2 class="text-lg font-semibold text-gray-900">Recently Added Organizations</h2>
            <a href="/admin/directory/organizations" class="text-sm text-blue-600 hover:underline">View all</a>
        </div>
        <div class="divide-y divide-gray-100">
            {% for org in recent_orgs %}
            <div class="px-6 py-4 flex items-center justify-between">
                <div class="flex items-center space-x-3 min-w-0 flex-1">
                    <div class="w-8 h-8 rounded bg-gray-200 flex items-center justify-center text-gray-500 text-xs font-medium flex-shrink-0">
                        {{ org.name[:2]|upper }}
                    </div>
                    <div class="min-w-0">
                        <a href="/admin/directory/organizations/{{ org.id }}" class="font-medium text-gray-900 hover:text-blue-600 truncate block">{{ org.name }}</a>
                        <div class="text-xs text-gray-500 flex items-center space-x-2">
                            {% if org.org_type == 'newspaper' %}
                            <span class="px-1.5 py-0.5 bg-blue-100 text-blue-700 rounded">Newspaper</span>
                            {% elif org.org_type == 'broadcaster' %}
                            <span class="px-1.5 py-0.5 bg-purple-100 text-purple-700 rounded">Broadcaster</span>
                            {% elif org.org_type == 'digital' %}
                            <span class="px-1.5 py-0.5 bg-green-100 text-green-700 rounded">Digital</span>
                            {% elif org.org_type == 'agency' %}
                            <span class="px-1.5 py-0.5 bg-amber-100 text-amber-700 rounded">Agency</span>
                            {% else %}
                            <span class="px-1.5 py-0.5 bg-gray-100 text-gray-700 rounded">{{ org.org_type|title }}</span>
                            {% endif %}
                            {% if org.country %}
                            <span>{{ org.country }}</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="flex items-center space-x-3 flex-shrink-0">
                    {% set stage_colors = {
                        "not_started": "bg-gray-100 text-gray-700",
                        "awareness": "bg-blue-100 text-blue-700",
                        "exploring": "bg-indigo-100 text-indigo-700",
                        "piloting": "bg-amber-100 text-amber-700",
                        "implementing": "bg-orange-100 text-orange-700",
                        "integrated": "bg-green-100 text-green-700",
                        "advanced": "bg-emerald-100 text-emerald-700",
                    } %}
                    {% set stage_labels = {
                        "not_started": "Not Started",
                        "awareness": "Awareness",
                        "exploring": "Exploring",
                        "piloting": "Piloting",
                        "implementing": "Implementing",
                        "integrated": "Integrated",
                        "advanced": "Advanced",
                    } %}
                    <select
                        onchange="quickUpdateStage('{{ org.id }}', this.value, this)"
                        class="text-xs border border-gray-300 rounded px-2 py-1 {{ stage_colors.get(org.ai_journey_stage or 'not_started', 'bg-gray-100 text-gray-700') }}"
                    >
                        {% for key, label in [("not_started", "Not Started"), ("awareness", "Awareness"), ("exploring", "Exploring"), ("piloting", "Piloting"), ("implementing", "Implementing"), ("integrated", "Integrated"), ("advanced", "Advanced")] %}
                        <option value="{{ key }}" {% if (org.ai_journey_stage or 'not_started') == key %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            {% else %}
            <div class="px-6 py-8 text-center text-gray-500">
                No organizations yet. <a href="/admin/directory/organizations/new" class="text-blue-600 hover:underline">Add one</a> or <a href="/admin/directory/import" class="text-blue-600 hover:underline">import from spreadsheet</a>.
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Skill Distribution -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">AI Skill Level Distribution</h2>
        <div class="grid grid-cols-4 gap-4">
            <a href="/admin/directory/journalists?skill_level=none" class="text-center p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                <div class="text-2xl font-bold text-gray-600">{{ skill_stats.get('none', 0) }}</div>
                <div class="text-sm text-gray-500">None</div>
            </a>
            <a href="/admin/directory/journalists?skill_level=beginner" class="text-center p-4 bg-yellow-50 rounded-lg hover:bg-yellow-100 transition">
                <div class="text-2xl font-bold text-yellow-600">{{ skill_stats.get('beginner', 0) }}</div>
                <div class="text-sm text-gray-500">Beginner</div>
            </a>
            <a href="/admin/directory/journalists?skill_level=intermediate" class="text-center p-4 bg-blue-50 rounded-lg hover:bg-blue-100 transition">
                <div class="text-2xl font-bold text-blue-600">{{ skill_stats.get('intermediate', 0) }}</div>
                <div class="text-sm text-gray-500">Intermediate</div>
            </a>
            <a href="/admin/directory/journalists?skill_level=advanced" class="text-center p-4 bg-green-50 rounded-lg hover:bg-green-100 transition">
                <div class="text-2xl font-bold text-green-600">{{ skill_stats.get('advanced', 0) }}</div>
                <div class="text-sm text-gray-500">Advanced</div>
            </a>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Recent Engagements -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-lg font-semibold text-gray-900">Recent Engagements</h2>
            </div>
            <div class="divide-y divide-gray-100">
                {% for engagement in recent_engagements %}
                <a href="/admin/directory/engagements/{{ engagement.id }}" class="block px-6 py-4 hover:bg-gray-50">
                    <div class="flex items-start justify-between">
                        <div>
                            <div class="font-medium text-gray-900">{{ engagement.title }}</div>
                            <div class="text-sm text-gray-500">
                                {{ engagement.journalist.full_name }} - {{ engagement.engagement_type|title }}
                            </div>
                        </div>
                        <div class="text-sm text-gray-500">{{ engagement.date.strftime('%b %d') }}</div>
                    </div>
                </a>
                {% else %}
                <div class="px-6 py-8 text-center text-gray-500">
                    No engagements yet
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Upcoming Follow-ups -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-lg font-semibold text-gray-900">Upcoming Follow-ups</h2>
            </div>
            <div class="divide-y divide-gray-100">
                {% for engagement in upcoming_followups %}
                <a href="/admin/directory/journalists/{{ engagement.journalist_id }}" class="block px-6 py-4 hover:bg-gray-50">
                    <div class="flex items-start justify-between">
                        <div>
                            <div class="font-medium text-gray-900">{{ engagement.journalist.full_name }}</div>
                            <div class="text-sm text-gray-500">{{ engagement.follow_up_actions[:80] }}{% if engagement.follow_up_actions|length > 80 %}...{% endif %}</div>
                        </div>
                        <div class="text-sm font-medium text-orange-600">{{ engagement.follow_up_date.strftime('%b %d') }}</div>
                    </div>
                </a>
                {% else %}
                <div class="px-6 py-8 text-center text-gray-500">
                    No upcoming follow-ups
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Quick Links -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">Quick Links</h2>
        <div class="grid grid-cols-2 md:grid-cols-6 gap-4">
            <a href="/admin/directory/organizations" class="p-4 border border-gray-200 rounded-lg hover:border-blue-300 hover:bg-blue-50 transition text-center">
                <div class="text-blue-600 font-medium">Organizations</div>
                <div class="text-sm text-gray-500">View all orgs</div>
            </a>
            <a href="/admin/directory/journalists" class="p-4 border border-gray-200 rounded-lg hover:border-blue-300 hover:bg-blue-50 transition text-center">
                <div class="text-blue-600 font-medium">Journalists</div>
                <div class="text-sm text-gray-500">View all contacts</div>
            </a>
            <a href="/admin/directory/journalists?skill_level=beginner" class="p-4 border border-gray-200 rounded-lg hover:border-blue-300 hover:bg-blue-50 transition text-center">
                <div class="text-blue-600 font-medium">Beginners</div>
                <div class="text-sm text-gray-500">Filter by skill</div>
            </a>
            <a href="/admin/directory/search" class="p-4 border border-gray-200 rounded-lg hover:border-blue-300 hover:bg-blue-50 transition text-center">
                <div class="text-blue-600 font-medium">Search</div>
                <div class="text-sm text-gray-500">Find anything</div>
            </a>
            <a href="/admin/directory/insights" class="p-4 border border-amber-200 rounded-lg hover:border-amber-400 hover:bg-amber-50 transition text-center">
                <div class="text-amber-600 font-medium">AI Insights</div>
                <div class="text-sm text-gray-500">Analyze data</div>
            </a>
            <a href="/admin/directory/sync" class="p-4 border border-indigo-200 rounded-lg hover:border-indigo-400 hover:bg-indigo-50 transition text-center">
                <div class="text-indigo-600 font-medium">GROUNDED Sync</div>
                <div class="text-sm text-gray-500">Sync to KB</div>
            </a>
            {% if feature_admin_directory_import %}
            <a href="/admin/directory/import" class="p-4 border border-emerald-200 rounded-lg hover:border-emerald-400 hover:bg-emerald-50 transition text-center">
                <div class="text-emerald-600 font-medium">Import</div>
                <div class="text-sm text-gray-500">Spreadsheet upload</div>
            </a>
            {% endif %}
        </div>
    </div>
</div>

<script>
async function quickUpdateStage(orgId, stage, selectEl) {
    try {
        const response = await fetch(`/admin/directory/organizations/${orgId}/journey/quick`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({stage: stage})
        });
        if (!response.ok) throw new Error('Failed to update');
        selectEl.classList.add('ring-2', 'ring-green-400');
        setTimeout(() => selectEl.classList.remove('ring-2', 'ring-green-400'), 1000);
    } catch (error) {
        alert('Error updating stage: ' + error.message);
    }
}
</script>
{% endblock %}
