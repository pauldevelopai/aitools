{% extends "admin/base.html" %}

{% block title %}Tool Reviews{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Page Header -->
    <div>
        <h1 class="text-2xl font-bold text-gray-900">Tool Reviews</h1>
        <p class="text-sm text-gray-600 mt-1">Moderate user reviews, manage flagged content</p>
    </div>

    <!-- Filter Tabs -->
    <div class="bg-white rounded-lg shadow">
        <div class="border-b border-gray-200">
            <nav class="flex -mb-px">
                <a href="/admin/reviews?filter=all"
                   class="px-6 py-3 text-sm font-medium {% if current_filter == 'all' %}border-b-2 border-blue-500 text-blue-600{% else %}text-gray-500 hover:text-gray-700 hover:border-gray-300{% endif %}">
                    All ({{ counts.all }})
                </a>
                <a href="/admin/reviews?filter=flagged"
                   class="px-6 py-3 text-sm font-medium {% if current_filter == 'flagged' %}border-b-2 border-blue-500 text-blue-600{% else %}text-gray-500 hover:text-gray-700 hover:border-gray-300{% endif %}">
                    Flagged ({{ counts.flagged }})
                </a>
                <a href="/admin/reviews?filter=hidden"
                   class="px-6 py-3 text-sm font-medium {% if current_filter == 'hidden' %}border-b-2 border-blue-500 text-blue-600{% else %}text-gray-500 hover:text-gray-700 hover:border-gray-300{% endif %}">
                    Hidden ({{ counts.hidden }})
                </a>
            </nav>
        </div>
    </div>

    <!-- Reviews List -->
    {% if reviews %}
    <div class="space-y-4">
        {% for review in reviews %}
        <div class="bg-white rounded-lg shadow overflow-hidden {% if review.is_hidden %}opacity-60{% endif %}">
            <div class="p-6">
                <div class="flex items-start justify-between">
                    <div class="flex-1 min-w-0">
                        <!-- Tool link and rating -->
                        <div class="flex items-center gap-3 mb-2">
                            <a href="/tools/{{ review.tool_slug }}" class="text-sm font-semibold text-blue-600 hover:text-blue-800">
                                {{ review.tool_slug }}
                            </a>
                            <div class="flex items-center">
                                {% for i in range(1, 6) %}
                                <span class="text-sm {% if i <= review.rating %}text-yellow-500{% else %}text-gray-300{% endif %}">&#9733;</span>
                                {% endfor %}
                            </div>
                            {% if review.use_case_tag %}
                            <span class="text-xs px-2 py-0.5 rounded-full bg-purple-100 text-purple-700">{{ review.use_case_tag }}</span>
                            {% endif %}
                            {% if review.is_hidden %}
                            <span class="text-xs px-2 py-0.5 rounded-full bg-red-100 text-red-800">Hidden</span>
                            {% endif %}
                            {% if review.flag_count > 0 %}
                            <span class="text-xs px-2 py-0.5 rounded-full bg-orange-100 text-orange-800">{{ review.flag_count }} flag(s)</span>
                            {% endif %}
                        </div>

                        <!-- Author info -->
                        <div class="flex items-center gap-2 text-sm text-gray-600 mb-2">
                            <a href="/admin/users/{{ review.author.id }}" class="font-medium text-blue-600 hover:text-blue-800">
                                {{ review.author.display_name or review.author.username or 'User' }}
                            </a>
                            <span class="text-gray-400">&middot;</span>
                            <span class="text-gray-500">{{ review.user_email }}</span>
                            <span class="text-gray-400">&middot;</span>
                            <span>{{ review.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
                        </div>

                        <!-- Comment -->
                        {% if review.comment %}
                        <p class="text-gray-900 mb-3">{{ review.comment }}</p>
                        {% else %}
                        <p class="text-gray-400 italic mb-3">No comment</p>
                        {% endif %}

                        <!-- Vote stats -->
                        <div class="text-xs text-gray-500">
                            {{ review.helpful_count }} found helpful &middot; {{ review.not_helpful_count }} found not helpful
                        </div>

                        <!-- Hidden reason -->
                        {% if review.is_hidden and review.hidden_reason %}
                        <div class="mt-3 bg-red-50 rounded p-3">
                            <p class="text-xs font-medium text-red-700 mb-1">Hidden Reason:</p>
                            <p class="text-sm text-red-800">{{ review.hidden_reason }}</p>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Actions -->
                    <div class="flex-shrink-0 ml-4 space-x-2">
                        {% if review.flag_count > 0 %}
                        <button onclick="showFlagsModal('{{ review.id }}')"
                                class="px-3 py-1.5 border border-orange-300 text-orange-700 text-sm rounded-md hover:bg-orange-50">
                            View Flags
                        </button>
                        {% endif %}

                        {% if not review.is_hidden %}
                        <button onclick="showHideModal('{{ review.id }}')"
                                class="px-3 py-1.5 bg-red-600 text-white text-sm rounded-md hover:bg-red-700">
                            Hide
                        </button>
                        {% else %}
                        <form action="/admin/reviews/{{ review.id }}/restore" method="POST" class="inline">
                            <button type="submit" class="px-3 py-1.5 bg-green-600 text-white text-sm rounded-md hover:bg-green-700">
                                Restore
                            </button>
                        </form>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="bg-white rounded-lg shadow p-12 text-center">
        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
        </svg>
        <h3 class="mt-4 text-lg font-medium text-gray-900">No reviews found</h3>
        <p class="mt-2 text-sm text-gray-500">
            {% if current_filter == 'flagged' %}
            No reviews have been flagged.
            {% elif current_filter == 'hidden' %}
            No reviews are currently hidden.
            {% else %}
            No reviews have been submitted yet.
            {% endif %}
        </p>
    </div>
    {% endif %}
</div>

<!-- Hide Review Modal -->
<div id="hide-modal" class="hidden fixed inset-0 z-50 overflow-y-auto">
    <div class="flex items-center justify-center min-h-screen px-4">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75" onclick="hideHideModal()"></div>
        <div class="relative bg-white rounded-lg shadow-xl max-w-md w-full">
            <form id="hide-form" method="POST" class="p-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Hide Review</h3>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Reason for hiding</label>
                    <textarea name="reason" rows="3" required placeholder="Explain why this review is being hidden..."
                              class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-red-500 focus:border-red-500"></textarea>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="hideHideModal()"
                            class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">
                        Cancel
                    </button>
                    <button type="submit"
                            class="px-4 py-2 bg-red-600 text-white rounded-md text-sm font-medium hover:bg-red-700">
                        Hide Review
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- View Flags Modal -->
<div id="flags-modal" class="hidden fixed inset-0 z-50 overflow-y-auto">
    <div class="flex items-center justify-center min-h-screen px-4">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75" onclick="hideFlagsModal()"></div>
        <div class="relative bg-white rounded-lg shadow-xl max-w-lg w-full max-h-96 overflow-y-auto">
            <div class="p-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Review Flags</h3>
                <div id="flags-content" class="space-y-3">
                    <!-- Flags loaded dynamically -->
                </div>
                <div class="mt-4 flex justify-end">
                    <button type="button" onclick="hideFlagsModal()"
                            class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    function showHideModal(reviewId) {
        document.getElementById('hide-form').action = '/admin/reviews/' + reviewId + '/hide';
        document.getElementById('hide-modal').classList.remove('hidden');
    }

    function hideHideModal() {
        document.getElementById('hide-modal').classList.add('hidden');
    }

    async function showFlagsModal(reviewId) {
        const content = document.getElementById('flags-content');
        content.innerHTML = '<p class="text-gray-500">Loading...</p>';
        document.getElementById('flags-modal').classList.remove('hidden');

        try {
            const response = await fetch('/admin/reviews/' + reviewId + '/flags');
            if (response.ok) {
                const flags = await response.json();
                if (flags.length === 0) {
                    content.innerHTML = '<p class="text-gray-500">No flags found.</p>';
                } else {
                    content.innerHTML = flags.map(flag => `
                        <div class="border border-gray-200 rounded p-3">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-xs px-2 py-0.5 rounded-full bg-orange-100 text-orange-700 capitalize">${flag.reason}</span>
                                <span class="text-xs text-gray-500">${new Date(flag.created_at).toLocaleDateString()}</span>
                            </div>
                            ${flag.details ? `<p class="text-sm text-gray-700">${flag.details}</p>` : '<p class="text-sm text-gray-400 italic">No details provided</p>'}
                        </div>
                    `).join('');
                }
            } else {
                content.innerHTML = '<p class="text-red-500">Failed to load flags.</p>';
            }
        } catch (error) {
            content.innerHTML = '<p class="text-red-500">Error loading flags.</p>';
        }
    }

    function hideFlagsModal() {
        document.getElementById('flags-modal').classList.add('hidden');
    }
</script>
{% endblock %}
